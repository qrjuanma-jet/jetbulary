<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jetbulary.com</title>
    <meta name="description" content="Aprende vocabulario inmersivo en ingl√©s y otros idiomas con IA. Jetbulary te ayuda a aprender sin memorizar listas, usando frases en contexto y pronunciaci√≥n nativa.">
    <meta name="keywords" content="vocabulario inmersivo, vocabulario sin memorizar, aprender ingl√©s con IA, vocabulario en contexto, app de idiomas gratuita, aprender idiomas online">
    <style>
        /* iOS Style Reset */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #FDFBF7; background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4c5b0' fill-opacity='0.2'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: #333; -webkit-font-smoothing: antialiased; }
        .container { width: 100%; max-width: 600px; padding: 20px; box-sizing: border-box; text-align: center; }
        
        h1 { font-size: 34px; font-weight: 700; letter-spacing: -0.5px; margin: 20px 0; color: #000; }
        h2 { font-size: 22px; font-weight: 600; margin: 15px 0; color: #000; }
        p { font-size: 17px; line-height: 1.4; color: #333; }
        
        button { background: #007AFF; color: white; border: none; padding: 16px; border-radius: 14px; font-size: 17px; font-weight: 600; cursor: pointer; margin: 8px 0; width: 100%; transition: opacity 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button:active { opacity: 0.7; }
        button:disabled { background: #8E8E93; cursor: not-allowed; }
        button.secondary { background: #E5E5EA; color: #000; }
        button.success { background: #34C759; }
        button.warning { background: #FF9500; color: white; }
        button.danger { background: #FF3B30; }
        
        input { padding: 16px; width: 100%; border: none; background: #fff; border-radius: 12px; margin-bottom: 15px; box-sizing: border-box; font-size: 17px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        select { width: 100%; padding: 16px; border-radius: 12px; border: none; background: #fff; margin-bottom: 15px; font-size: 17px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); -webkit-appearance: none; appearance: none; }
        
        .hidden { display: none !important; }
        
        /* Game Styles */
        .sentence { font-size: 20px; color: #333; font-weight: 500; margin-bottom: 20px; line-height: 1.4; }
        .word-target { font-size: 42px; color: #007AFF; font-weight: 800; margin: 20px 0; letter-spacing: -1px; }
        .mic-btn { width: 90px !important; height: 90px; border-radius: 50%; background: #FF3B30; font-size: 40px; display: flex; align-items: center; justify-content: center; margin: 20px auto; cursor: pointer; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3); transition: transform 0.1s; }
        .mic-btn:active { transform: scale(0.95); }
        .mic-btn.listening { background: #ff0000; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .feedback { margin-top: 10px; font-weight: 600; min-height: 24px; font-size: 18px; }
        .correct { color: #34C759; }
        .incorrect { color: #FF3B30; }
        .youglish { display: block; margin-top: 20px; color: #007AFF; text-decoration: none; font-weight: 500; font-size: 16px; }
        
        .stat-card { background: #fff; padding: 20px; border-radius: 14px; margin-bottom: 12px; display: flex; justify-content: space-between; font-size: 18px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        /* Accordion Topics */
        details { background: #fff; margin: 10px 0; border-radius: 14px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: left; }
        summary { padding: 18px; cursor: pointer; font-weight: 600; font-size: 17px; list-style: none; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        summary::-webkit-details-marker { display: none; }
        summary::after { content: '+'; font-size: 20px; color: #007AFF; font-weight: 300; }
        details[open] summary::after { content: '‚àí'; color: #FF3B30; }
        details[open] { background: white; }
        .topic-content { padding: 15px; border-top: 1px solid #f2f2f7; display: flex; flex-direction: column; gap: 10px; }
        .topic-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .topic-actions button { flex: 1; font-size: 15px; padding: 12px; margin: 0; border-radius: 10px; }

        /* Image Avatar CSS */
        .avatar-container { width: 100%; margin: 0 auto 15px; position: relative; }
        .avatar-img { width: 100%; height: auto; display: block; mix-blend-mode: multiply; border-radius: 12px; }
        
        /* Vocab List */
        .vocab-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #fff; margin-bottom: 1px; text-align: left; }
        .vocab-item:first-child { border-top-left-radius: 14px; border-top-right-radius: 14px; }
        .vocab-item:last-child { border-bottom-left-radius: 14px; border-bottom-right-radius: 14px; }
        .vocab-info { flex-grow: 1; }
        .vocab-en { font-weight: 600; font-size: 18px; color: #000; }
        .vocab-es { color: #8E8E93; font-size: 15px; margin-top: 2px; }
        .vocab-score { font-size: 12px; padding: 4px 8px; border-radius: 6px; color: white; margin-left: 8px; font-weight: 600; }
        .score-high { background: #34C759; }
        .score-med { background: #FF9500; }
        .score-low { background: #FF3B30; }
        
        /* Grammar Course */
        .level-header { background: transparent; padding: 10px 5px; font-weight: 700; font-size: 20px; margin-top: 20px; text-align: left; color: #000; }
        .lesson-item { background: white; border-bottom: 1px solid #f2f2f7; padding: 16px; text-align: left; cursor: pointer; font-size: 17px; }
        .lesson-item:first-of-type { border-top-left-radius: 14px; border-top-right-radius: 14px; }
        .lesson-item:last-of-type { border-bottom-left-radius: 14px; border-bottom-right-radius: 14px; border-bottom: none; }
        .lesson-item:active { background: #f2f2f7; }
        
        /* Timer Bar */
        #timer-container { width: 100%; height: 8px; background: #E5E5EA; border-radius: 4px; margin: 20px 0; overflow: hidden; }
        #timer-bar { height: 100%; width: 0%; background: #34C759; transition: width 0.1s linear, background 0.5s; }
        
        
        .app-logo { width: calc(100% + 40px); margin-left: -20px; margin-top: -20px; height: auto; margin-bottom: 10px; display: block; object-fit: cover; cursor: pointer; mix-blend-mode: multiply; }
        
        /* Cookie Banner */
        #cookie-banner { position: fixed; bottom: 0; left: 0; width: 100%; background: #222; color: white; padding: 15px; text-align: center; z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); }
        @media (min-width: 600px) { #cookie-banner { flex-direction: row; justify-content: center; } }
        #cookie-banner p { margin: 0; font-size: 0.9rem; color: #eee; }
        #cookie-banner a { color: #4da3ff; }
        #cookie-banner button { width: auto; padding: 8px 20px; margin: 0; font-size: 0.9rem; }
        
        /* Install Button */
        #install-btn { margin: 30px auto 40px auto; padding: 12px 24px; font-size: 1rem; background: #007AFF; color: white; border-radius: 30px; border: none; cursor: pointer; display: block; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Chinese Font Adjustment */
        .lang-ja .sentence, .lang-ja .word-target { font-family: "Hiragino Kaku Gothic Pro", "Meiryo", "Noto Sans JP", sans-serif; font-size: 1.3em; }
        
        .auto-mic-on { background-color: #34C759 !important; color: white !important; border: 1px solid #28a745 !important; }
        
        @media print {
            body * { visibility: hidden; }
            #diploma-preview, #diploma-preview * { visibility: visible; }
            #diploma-preview { position: fixed; left: 0; top: 0; width: 100%; margin: 0; padding: 0; border: 5px solid #007AFF !important; }
            @page { size: auto; margin: 0mm; }
            body { background: white; }
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3361037839787257" crossorigin="anonymous"></script>
</head>
<body>

    <!-- VISTA LOGIN -->
    <div id="view-login" class="container">
        <header style="margin-bottom: 40px;">
            <img src="logo.jpg" alt="Jetbulary Logo" class="app-logo" style="border-radius: 0 0 20px 20px;">
            <h2 style="color: #007AFF; margin-bottom: 10px;">VUELA ALTO, APRENDE M√ÅS 
                <a href="https://api.whatsapp.com/send?text=Descubre%20Jetbulary.com%20-%20Aprende%20idiomas%20con%20IA%20gratis!" target="_blank" style="display: inline-block; vertical-align: middle; margin-left: 5px; text-decoration: none;">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.381a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.891-9.885 9.891m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" fill="#25D366"/></svg>
                </a>
            </h2>
            <p style="font-size: 1.2rem; color: #555; max-width: 800px; margin: 0 auto 20px auto;">Jetbulary: Aprende idiomas como un nativo de forma gratuita. Navega en Jetbulary.com para encontrar tu propio tesoro. Tu <a href="https://console.groq.com/keys" target="_blank" style="color:#007AFF; text-decoration: none; font-weight: bold;">üîë llave personal</a>, en groq, entra con tu cuenta de google y pulsa en create API KEY, c√≥piala y p√©gala en el siguiente recuadro (no guardamos tus datos)</p>
            
            <div style="position: relative; max-width: 400px; margin: 0 auto;">
                <input type="password" id="api-key-input" placeholder="Introduce tu API Key de Groq..." style="margin-bottom: 15px; padding-right: 40px;">
                <span onclick="app.toggleApiKeyVisibility()" style="position: absolute; right: 15px; top: 15px; cursor: pointer; font-size: 1.2rem;">üëÅÔ∏è</span>
            </div>
            <div style="max-width: 400px; margin: 0 auto;">
                <button onclick="app.saveApiKey()" class="success">Entrar a Jetbulary</button>
                <p style="font-size: 0.85rem; color: #666; margin-top: 15px; margin-bottom: 5px;">¬øYa tienes tu API Key y guardaste tu avance?</p>
                <button onclick="app.importDB()" class="secondary">üìÇ Restaurar Avance</button>
            </div>
        </header>

        <nav style="margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <a href="#" onclick="return false;" style="margin: 0 10px; text-decoration: none; color: #333; font-weight: bold;">Inicio</a>
            <a href="#features" style="margin: 0 10px; text-decoration: none; color: #555;">Caracter√≠sticas</a>
            <a href="#methodology" style="margin: 0 10px; text-decoration: none; color: #555;">Metodolog√≠a</a>
            <a href="#faq" style="margin: 0 10px; text-decoration: none; color: #555;">Preguntas Frecuentes</a>
        </nav>

        <section style="text-align: left; margin-bottom: 40px;">
            <h2 style="color: #007AFF; margin-bottom: 20px;">Aprendizaje Inmersivo con IA</h2>
            <p style="margin-bottom: 15px;">Jetbulary no es simplemente otra aplicaci√≥n de tarjetas de memoria. Utilizamos modelos de lenguaje avanzados (LLMs) para generar contenido educativo personalizado al instante. Olv√≠date de las listas de palabras est√°ticas y aburridas; aqu√≠ t√∫ eliges el tema y la IA construye la lecci√≥n para ti.</p>
            <p>Nuestro enfoque se basa en el <strong>aprendizaje contextual</strong>. No aprendes palabras aisladas, sino que las ves y escuchas dentro de frases completas, lo que ayuda a tu cerebro a retener el significado y el uso gramatical de forma natural.</p>
            <p>Adem√°s, practicando podr√°s conseguir un <strong>Diploma Informativo Jetbulary (no oficial)</strong>.</p>
            <img src="Diplo.jpg" alt="Diploma Jetbulary" style="width: 150px; display: block; margin: 10px auto; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            
            <h3 style="margin-top: 30px; margin-bottom: 15px;">¬øC√≥mo funciona?</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div style="background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <h4 style="margin-top: 0;">1. Elige tu Tema</h4>
                    <p style="font-size: 0.95rem;">Desde "Negocios Internacionales" hasta "Cocina Italiana". T√∫ decides qu√© quieres aprender hoy.</p>
                </div>
                <div style="background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <h4 style="margin-top: 0;">2. Generaci√≥n IA</h4>
                    <p style="font-size: 0.95rem;">Nuestra tecnolog√≠a conecta con Groq para crear vocabulario relevante, frases de ejemplo y traducciones precisas en segundos.</p>
                </div>
                <div style="background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <h4 style="margin-top: 0;">3. Pr√°ctica Activa</h4>
                    <p style="font-size: 0.95rem;">Escucha pronunciaciones nativas, usa el reconocimiento de voz para mejorar tu acento y recibe feedback instant√°neo.</p>
                </div>
            </div>

            <h3 id="features" style="margin-top: 30px;">Caracter√≠sticas Principales</h3>
            <ul style="padding-left: 20px; color: #444; text-align: left; line-height: 1.6;">
                <li><strong>IA Generativa Ilimitada:</strong> Nunca te quedar√°s sin contenido nuevo.</li>
                <li><strong>Reconocimiento de Voz Avanzado:</strong> Evaluaci√≥n de pronunciaci√≥n en tiempo real.</li>
                <li><strong>Sistema de Repaso Espaciado:</strong> Algoritmos inteligentes que detectan tus fallos y programan repasos autom√°ticos.</li>
                <li><strong>Soporte Multi-idioma:</strong> Aprende Ingl√©s, Franc√©s, Alem√°n, Chino, y m√°s.</li>
                <li><strong>Soporte Multi-idioma:</strong> Aprende Ingl√©s, Franc√©s, Alem√°n, Italiano, y m√°s.</li>
                <li><strong>Integraci√≥n Multimedia:</strong> Enlaces directos a YouGlish y diccionarios contextuales.</li>
            </ul>
        </section>

        <section id="methodology" style="text-align: left; margin-bottom: 40px; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <h2 style="color: #007AFF;">Nuestra Metodolog√≠a</h2>
            <p>En Jetbulary creemos que la mejor forma de aprender un idioma es us√°ndolo. Por eso, hemos eliminado las barreras tradicionales:</p>
            <ul style="list-style-type: none; padding: 0;">
                <li style="margin-bottom: 10px;">üß† <strong>Input Comprensible:</strong> Recibes frases que est√°n ligeramente por encima de tu nivel actual, facilitando la adquisici√≥n natural.</li>
                <li style="margin-bottom: 10px;">üó£Ô∏è <strong>Output Activo:</strong> Te obligamos a hablar desde el primer d√≠a. Sin pronunciaci√≥n, no hay avance.</li>
                <li style="margin-bottom: 10px;">üîÑ <strong>Feedback Inmediato:</strong> La IA te corrige al instante, evitando que fosilices errores.</li>
            </ul>
        </section>

        <section id="faq" style="text-align: left; margin-bottom: 40px;">
            <h2 style="color: #007AFF;">Preguntas Frecuentes (FAQ)</h2>
            <details style="margin-bottom: 10px; background: #fff; padding: 15px; border-radius: 8px;">
                <summary style="font-weight: bold; cursor: pointer;">¬øEs realmente gratis?</summary>
                <p style="margin-top: 10px;">S√≠, Jetbulary es una herramienta gratuita. Utilizamos la API de Groq que ofrece un plan gratuito generoso para desarrolladores y estudiantes.</p>
            </details>
            <details style="margin-bottom: 10px; background: #fff; padding: 15px; border-radius: 8px;">
                <summary style="font-weight: bold; cursor: pointer;">¬øQu√© idiomas puedo aprender?</summary>
                <p style="margin-top: 10px;">Actualmente soportamos Ingl√©s, Alem√°n, Franc√©s, Italiano, Euskera, Chino, Ruso, Portugu√©s, Catal√°n, Gallego y Coreano.</p>
                <p style="margin-top: 10px;">Actualmente soportamos Ingl√©s, Alem√°n, Franc√©s, Italiano, Euskera, Ruso, Portugu√©s, Catal√°n y Gallego.</p>
            </details>
            <details style="margin-bottom: 10px; background: #fff; padding: 15px; border-radius: 8px;">
                <summary style="font-weight: bold; cursor: pointer;">¬øNecesito registrarme?</summary>
                <p style="margin-top: 10px;">No necesitas crear una cuenta con email. Tu progreso se guarda localmente en tu dispositivo. Solo necesitas una API Key para activar la inteligencia artificial.</p>
            </details>
        </section>

        <footer style="margin-top: 60px; font-size: 0.85rem; color: #888; border-top: 1px solid #eee; padding-top: 30px;">
            <p>&copy; 2026 Jetbulary. Todos los derechos reservados.</p>
            <p>
                <a href="#" onclick="app.showPrivacy()" style="color: #888; text-decoration: none; margin: 0 10px;">Pol√≠tica de Privacidad</a> | 
                <a href="#" onclick="app.showTerms()" style="color: #888; text-decoration: none; margin: 0 10px;">T√©rminos de Uso</a>
            </p>
        </footer>
    </div>

    <!-- VISTA PRIVACIDAD -->
    <div id="view-privacy" class="container hidden" style="text-align: left;">
        <h2>Pol√≠tica de Privacidad</h2>
        <p>En Jetbulary, respetamos su privacidad. Esta aplicaci√≥n funciona principalmente en el lado del cliente (su dispositivo).</p>
        <h3>Recopilaci√≥n de Datos</h3>
        <p>No almacenamos sus datos personales en servidores externos. Su progreso, vocabulario y configuraciones se guardan localmente en su dispositivo utilizando `localStorage`.</p>
        <h3>Uso de API de Terceros</h3>
        <p>Para generar contenido, la aplicaci√≥n env√≠a solicitudes a la API de Groq. Su API Key se almacena localmente en su dispositivo y solo se utiliza para autenticar estas solicitudes.</p>
        <h3>Cookies</h3>
        <p>Utilizamos cookies t√©cnicas esenciales para el funcionamiento de la aplicaci√≥n y cookies de Google AdSense para mostrar publicidad personalizada.</p>
        <button onclick="app.showLogin()" class="secondary" style="margin-top: 20px;">Volver</button>
    </div>

    <!-- VISTA T√âRMINOS -->
    <div id="view-terms" class="container hidden" style="text-align: left;">
        <h2>T√©rminos de Uso</h2>
        <p>Al utilizar Jetbulary, usted acepta los siguientes t√©rminos:</p>
        <h3>Uso Personal</h3>
        <p>Esta aplicaci√≥n es para uso personal y educativo.</p>
        <h3>Contenido Generado por IA</h3>
        <p>El contenido educativo es generado por Inteligencia Artificial. Aunque nos esforzamos por la precisi√≥n, puede haber errores ocasionales en las traducciones o explicaciones.</p>
        <h3>Responsabilidad</h3>
        <p>Jetbulary no se hace responsable del uso indebido de la aplicaci√≥n o de la exactitud absoluta del contenido generado.</p>
        <button onclick="app.showLogin()" class="secondary" style="margin-top: 20px;">Volver</button>
    </div>

    <!-- VISTA DASHBOARD -->
    <div id="view-dashboard" class="container hidden">
        <img src="logo.jpg" alt="Jetbulary Logo" class="app-logo" style="border-radius: 0 0 20px 20px;">
        <h2 style="color: #007AFF; margin-bottom: 10px;">VUELA ALTO, APRENDE M√ÅS
            <a href="https://api.whatsapp.com/send?text=Descubre%20Jetbulary.com%20-%20Aprende%20idiomas%20con%20IA%20gratis!" target="_blank" style="display: inline-block; vertical-align: middle; margin-left: 5px; text-decoration: none;">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.381a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.891-9.885 9.891m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" fill="#25D366"/></svg>
            </a>
        </h2>
        
        <!-- AVATAR DASHBOARD -->
        <div class="avatar-container" id="avatar-dash">
        </div>
        
        <select id="lang-selector" onchange="app.changeLanguage()">
            <option value="en">üá¨üáß Ingl√©s (English)</option>
            <option value="de">üá©üá™ Alem√°n (Deutsch)</option>
            <option value="fr">üá´üá∑ Franc√©s (Fran√ßais)</option>
            <option value="it">üáÆüáπ Italiano (Italiano)</option>
            <option value="eu">üü¢‚ö™üî¥ Euskera (Euskara)</option>
            <option value="ru">üá∑üá∫ Ruso (–†—É—Å—Å–∫–∏–π)</option>
            <option value="pt">üáµüáπ Portugu√©s (Portugu√™s)</option>
            <option value="ca">üü°üî¥ Catal√°n (Catal√†)</option>
            <option value="gl">‚ö™üîµ Gallego (Galego)</option>
        </select>

        <div style="display: flex; gap: 5px; margin-bottom: 15px;">
            <button onclick="app.startReview()" class="warning">‚ö° Repaso</button>
            <button onclick="app.showStats()" style="background-color: #17a2b8;">üìä Stats</button>
        </div>
        <div style="display: flex; gap: 5px; margin-bottom: 15px;">
            <button onclick="app.showVocab()" class="secondary">üìö Vocabulario</button>
            <button onclick="app.showGrammar()" class="secondary">üìñ Gram√°tica</button>
            <button onclick="app.showResources()" class="secondary">‚ûï Recursos Extra</button>
        </div>

        <h3>A√±ade Tema</h3>
        <div style="position: relative; margin-bottom: 15px;">
            <input type="text" id="new-topic-input" placeholder="Ej: Viajes, Amor, Trabajo..." style="margin-bottom: 0; padding-right: 50px;">
            <span onclick="app.listenTopic(this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.5rem; z-index: 10;">üé§</span>
        </div>
        <button onclick="app.createTopic()" id="btn-create">Generar con IA</button>
        
        <details open style="margin-top: 15px; background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
            <summary style="font-size: 0.9rem; color: #007AFF;">üí° Sugerencias de Temas</summary>
            <div id="suggestions-container" style="padding: 15px;"></div>
        </details>
        
        <div id="topic-list" style="margin-top: 20px;"></div>
        
        <button onclick="app.logout()" class="secondary">Cambiar API Key</button>

        <!-- PUBLICIDAD ADSENSE -->
        <div style="margin: 20px 0; text-align: center; min-height: 90px; background: #f4f4f4; border-radius: 8px; overflow: hidden;">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-3361037839787257"
                 data-ad-slot="TU_ID_DE_ANUNCIO_AQUI"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>

        <!-- SECCI√ìN PREMIUM / SOPORTE -->
        <div style="margin-top: 30px; padding: 20px; background: #fff; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
            <h3 style="margin-top: 0; color: #007AFF;">Sincronizaci√≥n y Apoyo</h3>
            <button onclick="app.exportDB()" class="secondary" style="margin-bottom: 15px;">1. Guardar Avance</button>
            <button onclick="app.checkDiploma()" class="secondary" style="margin-bottom: 15px; background: #E3F2FD; color: #0277BD; border: 1px solid #81D4FA;">2. Consigue Diploma Jetbulary</button>
            <button onclick="app.showDiplomas()" class="secondary" style="margin-bottom: 15px; background: #E8F5E9; color: #2E7D32; border: 1px solid #A5D6A7;">3. Diplomas conseguidos</button>
            <p style="font-size: 0.9rem; color: #555; margin-bottom: 15px;">Guardar Avance e Importar Avance es GRATIS, pulsa en la tacita de caf√© y vuelve a la p√°gina, ver√°s el bot√≥n de Importar Avance, s√≥lo SI QUIERES, PUEDES APORTAR AL PROYECTO, VUELA ALTO, APRENDE M√ÅS, ¬°Gracias por usar Jetbulary!</p>
            <p style="font-weight: bold; margin-bottom: 5px;">Apoya el proyecto, pulsando Tip <span onclick="app.secretAdmin()" style="color: #007AFF; cursor: pointer;">.</span></p>
            <div onclick="app.unlockSync()" style="margin-bottom: 15px; cursor: pointer; display: inline-block;">
                <script type='text/javascript' src='https://storage.ko-fi.com/cdn/widget/Widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Support me on Ko-fi', '#72a4f2', 'X8X61UAY6L');kofiwidget2.draw();</script>
            </div>
            <div id="sync-buttons" class="hidden" style="display: flex; gap: 10px; margin-top: 10px;">
                <button onclick="app.importDB()" class="secondary">‚¨ÜÔ∏è Importar Avance</button>
            </div>
        </div>
    </div>

    <!-- VISTA JUEGO -->
    <div id="view-game" class="container hidden">
        <img src="logo.jpg" alt="Jetbulary Logo" class="app-logo" onclick="app.showDashboard()" style="border-radius: 0 0 20px 20px;">
        <!-- AVATAR -->
        <div class="avatar-container" id="avatar">
        </div>

        <p class="sentence" id="sentence-display"></p>
        <small id="sentence-translation" style="display:block; margin-bottom: 20px; color: #666; font-size: 16px;">Traducci√≥n</small>
        
        <div class="word-target" id="word-display"></div>

        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 10px;">
             <button onclick="game.speak()" class="secondary" style="width: auto; padding: 10px; margin: 0;">üîä Frase</button>
             <button onclick="game.speakWordSlow()" class="secondary" style="width: auto; padding: 10px; margin: 0;">üê¢ Palabra</button>
        </div>

        <button class="mic-btn" id="mic-btn" onclick="game.toggleMic()">üé§</button>
        <button id="btn-auto-mic" onclick="game.toggleAutoMic()" class="auto-mic-on" style="width: auto; padding: 8px 15px; margin-top: 5px; font-size: 0.9rem; border-radius: 20px;">üéôÔ∏è Auto: ON</button>
        <p id="prompt-pronounce" style="margin-top: 10px; color: #888;">Pulsa para hablar</p>
        
        <div id="timer-container" class="hidden"><div id="timer-bar"></div></div>
        
        <p id="spoken-text" style="color:#333; font-style:italic; min-height: 20px; margin: 10px 0;">...</p>
        <div id="feedback-msg" class="feedback"></div>
        
        <div id="fail-options" class="hidden" style="display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap;">
            <button onclick="game.retry()" class="warning" style="width: auto; flex: 1;">üîÑ Reintentar</button>
            <button onclick="document.getElementById('youglish-link').click()" class="secondary" style="width: auto; flex: 1;">üëÇ O√≠r Nativos (YouGlish)</button>
            <button onclick="game.next()" class="secondary" style="width: auto; flex: 1;">‚è≠Ô∏è Saltar</button>
        </div>
        
        <div id="ai-advice" class="hidden" style="margin-top: 15px; font-weight: 500; color: #333; font-size: 17px;"></div>
        
        <a id="youglish-link" href="#" target="_blank" style="display:none;">NATIVOS (YouGlish)</a>

        <button id="next-btn" class="success hidden" onclick="game.next()">Siguiente ‚û°</button>
    </div>

    <!-- VISTA VOCABULARIO -->
    <div id="view-vocab" class="container hidden">
        <h2>Mi Vocabulario</h2>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <button onclick="vocab.sort('score')" class="secondary" style="font-size:0.8rem">Dificultad</button>
            <button onclick="vocab.sort('topic')" class="secondary" style="font-size:0.8rem">Tema</button>
            <button onclick="vocab.sort('alpha')" class="secondary" style="font-size:0.8rem">A-Z</button>
        </div>
        <div id="vocab-list" style="max-height: 400px; overflow-y: auto;"></div>
        <button onclick="app.showDashboard()" class="secondary" style="margin-top:10px;">Volver</button>
    </div>

    <!-- VISTA GRAM√ÅTICA -->
    <div id="view-grammar" class="container hidden">
        <!-- AVATAR GRAMMAR -->
        <div class="avatar-container" id="avatar-grammar">
        </div>
        
        <h2 id="grammar-title">Gram√°tica</h2>
        
        <button id="btn-alphabet" onclick="app.showAlphabet()" class="warning hidden" style="margin-bottom: 15px;">üî§ Alfabeto / Signos</button>
        <div style="display: flex; gap: 5px; margin-bottom: 20px;">
            <button onclick="app.showGrammarCourse()" class="success">üéì Curso Guiado</button>
            <button onclick="document.getElementById('grammar-qa').classList.remove('hidden'); document.getElementById('grammar-course-list').classList.add('hidden');" class="secondary">‚ùì Pregunta R√°pida</button>
        </div>

        <!-- Pregunta R√°pida -->
        <div id="grammar-qa" class="hidden">
            <p>Pide a la profesora que te explique algo:</p>
            <input type="text" id="grammar-query" placeholder="Ej: Present Perfect, Verbos modales...">
            <button onclick="app.askGrammar()" id="btn-grammar">Preguntar</button>
            <div id="grammar-content" style="text-align: left; margin-top: 20px; background: #f9f9f9; padding: 10px; border-radius: 8px; min-height: 100px;"></div>
        </div>

        <!-- Curso Guiado -->
        <div id="grammar-course-list" class="hidden"></div>

        <button onclick="app.showDashboard()" class="secondary" style="margin-top:10px;">Volver</button>
    </div>

    <!-- VISTA ALFABETO -->
    <div id="view-alphabet" class="container hidden">
        <h2>Alfabeto / Signos</h2>
        <div id="alphabet-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px;"></div>
        <button onclick="app.showGrammar()" class="secondary" style="margin-top:20px;">Volver</button>
    </div>

    <!-- VISTA RECURSOS -->
    <div id="view-resources" class="container hidden">
        <h2>Recursos Extra</h2>
        <div id="resources-content" style="text-align: left;"></div>
        <button onclick="app.showDashboard()" class="secondary" style="margin-top:20px;">Volver</button>
    </div>

    <!-- VISTA CULTURA -->
    <div id="view-culture" class="container hidden">
        <h2 id="culture-title">Cultura</h2>
        <div id="culture-content" style="text-align: left; line-height: 1.6;"></div>
        <button onclick="app.showDashboard()" class="secondary" style="margin-top:20px;">Volver</button>
    </div>

    <!-- VISTA ESTAD√çSTICAS -->
    <div id="view-stats" class="container hidden">
        <h2>Estad√≠sticas</h2>
        <div class="stat-card"><span>Palabras:</span> <strong id="stat-total">0</strong></div>
        <div class="stat-card"><span>Precisi√≥n:</span> <strong id="stat-acc">0%</strong></div>
        <button onclick="app.showDashboard()" class="secondary">Volver</button>
    </div>

    <!-- VISTA DIPLOMA -->
    <div id="view-diploma" class="container hidden">
        <div id="diploma-content"></div>
    </div>

    <!-- COOKIE BANNER -->
    <div id="cookie-banner" class="hidden">
        <p>üç™ Usamos cookies para mejorar tu experiencia y mostrar anuncios. Al continuar, aceptas nuestra <a href="#" onclick="app.showPrivacy()">Pol√≠tica de Privacidad</a>.</p>
        <button onclick="app.acceptCookies()" class="success">Aceptar</button>
    </div>

    <button id="install-btn" onclick="app.installApp()">üì≤ Ponte un Acceso Directo en tu Pantalla a Jetbulary.com</button>

<script>
    // --- BASE DE DATOS LOCAL ---
    const DB_KEY = 'jetbulary_db';
    const API_KEY_STORAGE = 'jetbulary_apikey';
    let db = { topics: [], words: [], progress: [], grammar_courses: {} };
    let currentLang = 'en';

    const app = {
        init: () => {
            try {
                const data = localStorage.getItem(DB_KEY);
                if (data) db = JSON.parse(data);
            } catch(e) { console.error("Error DB", e); }
            if (!db.grammar_courses) db.grammar_courses = {};
            
            const savedLang = localStorage.getItem('jetbulary_lang');
            if(savedLang) {
                currentLang = savedLang;
                document.body.className = `lang-${currentLang}`;
                document.documentElement.lang = currentLang;
            }
            
            const savedKey = localStorage.getItem(API_KEY_STORAGE);
            if(savedKey) document.getElementById('api-key-input').value = savedKey;
            else document.getElementById('api-key-input').value = "";
            
            document.getElementById('new-topic-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') app.createTopic();
            });
            
            if(savedKey) {
                app.showDashboard('replace');
            } else {
                app.showLogin('replace');
            }
            app.checkCookies();
            
            window.onpopstate = (event) => {
                if (event.state && event.state.view) {
                    if (event.state.view === 'view-dashboard') app.showDashboard('none');
                    else if (event.state.view === 'view-login') app.showLogin('none');
                    else app.switchView(event.state.view, 'none');
                }
            };
        },
        saveDB: () => localStorage.setItem(DB_KEY, JSON.stringify(db)),
        
        showLogin: (h) => app.switchView('view-login', h),
        showPrivacy: () => app.switchView('view-privacy'),
        showTerms: () => app.switchView('view-terms'),
        showDashboard: (h) => {
            app.switchView('view-dashboard', h);
            document.getElementById('lang-selector').value = currentLang;
            document.body.className = `lang-${currentLang}`;
            game.updateAvatar();
            app.renderTopics();
            app.renderSuggestions();
            app.updateLangCounts();
        },
        changeLanguage: () => {
            currentLang = document.getElementById('lang-selector').value;
            localStorage.setItem('jetbulary_lang', currentLang);
            document.body.className = `lang-${currentLang}`;
            document.documentElement.lang = currentLang;
            game.updateAvatar();
            app.renderTopics();
        },
        showStats: () => {
            app.switchView('view-stats');
            const prog = db.progress;
            if(!prog) return;
            const total = prog.length;
            const succ = prog.reduce((a,b) => a + b.successes, 0);
            const att = prog.reduce((a,b) => a + b.attempts, 0);
            const acc = att > 0 ? Math.round((succ/att)*100) : 0;
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-acc').innerText = acc + '%';
        },
        showVocab: () => {
            app.switchView('view-vocab');
            vocab.render();
        },
        showResources: () => {
            app.switchView('view-resources');
            app.loadResources();
        },
        showGrammar: () => {
            app.switchView('view-grammar');
            const specialLangs = ['ru', 'ja', 'el'];
            if(specialLangs.includes(currentLang)) document.getElementById('btn-alphabet').classList.remove('hidden');
            else document.getElementById('btn-alphabet').classList.add('hidden');
            
            document.getElementById('grammar-title').innerText = `Gram√°tica (${app.getLangName()})`;
            game.updateAvatar();
            app.showGrammarCourse();
        },
        switchView: (id, historyAction = 'push') => {
            document.querySelectorAll('.container').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            
            if (historyAction === 'push') {
                history.pushState({ view: id }, null, "");
            } else if (historyAction === 'replace') {
                history.replaceState({ view: id }, null, "");
            }
        },
        
        logout: () => {
            if(confirm("¬øQuieres cambiar la API Key?")) {
                localStorage.removeItem(API_KEY_STORAGE);
                app.showLogin();
            }
        },
        saveApiKey: () => {
            const k = document.getElementById('api-key-input').value.trim();
            if(k) {
                localStorage.setItem(API_KEY_STORAGE, k);
                app.showDashboard();
            } else {
                alert("Introduce una API Key v√°lida.");
            }
        },
        toggleApiKeyVisibility: () => {
            const input = document.getElementById('api-key-input');
            input.type = input.type === 'password' ? 'text' : 'password';
        },
        
        listenTopic: (btn) => {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return alert("Tu navegador no soporta voz.");
            
            const recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            
            btn.innerText = "üëÇ";
            
            recognition.onresult = (e) => {
                document.getElementById('new-topic-input').value = e.results[0][0].transcript;
            };
            
            recognition.onend = () => { btn.innerText = "üé§"; };
            recognition.start();
        },
        
        installApp: () => {
            if (window.deferredPrompt) {
                window.deferredPrompt.prompt();
                window.deferredPrompt.userChoice.then((choiceResult) => {
                    window.deferredPrompt = null;
                    document.getElementById('install-btn').classList.add('hidden');
                });
            } else {
                alert("Crea un acceso directo para entrar m√°s r√°pido:\n\nüçè iOS: Pulsa el bot√≥n 'Compartir' y luego 'A√±adir a Inicio'.\n\nü§ñ Android: Pulsa el men√∫ (3 puntos) y elige 'A√±adir a pantalla de inicio'.\n\nüíª Windows: Pulsa el icono (+) en la barra de direcciones.");
            }
        },
        
        unlockSync: () => {
            document.getElementById('sync-buttons').classList.remove('hidden');
        },
        
        exportDB: () => {
            const backup = {
                ...db,
                apiKey: localStorage.getItem(API_KEY_STORAGE)
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "Avance_Jetbulary.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        },
        
        secretClicks: 0,
        secretTimer: null,
        secretAdmin: () => {
            app.secretClicks++;
            if(app.secretTimer) clearTimeout(app.secretTimer);
            app.secretTimer = setTimeout(() => { app.secretClicks = 0; }, 2000);
            
            if (app.secretClicks === 7) {
                app.secretClicks = 0;
                const pass = prompt("Contrase√±a de Administrador:");
                if (pass === "2002") {
                    app.showAdminPanel();
                }
            }
        },
        showAdminPanel: () => {
            const div = document.createElement('div');
            div.id = 'admin-panel';
            div.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; display:flex; justify-content:center; align-items:center;";
            div.innerHTML = `<div style="background:white; padding:20px; border-radius:12px; width:90%; max-width:300px; text-align:center;"><h3 style="margin-top:0;">Admin: ${app.getLangName()}</h3><p>A√±adir palabras dominadas:</p><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;"><button onclick="app.cheat(100)" class="success">+100</button><button onclick="app.cheat(500)" class="success">+500</button><button onclick="app.cheat(1000)" class="success">+1000</button><button onclick="app.cheat(5000)" class="success">+5000</button></div><button onclick="document.body.removeChild(document.getElementById('admin-panel'))" class="secondary">Cerrar</button></div>`;
            document.body.appendChild(div);
        },
        cheat: (amount) => {
            const topicId = Date.now();
            db.topics.push({ id: topicId, name: "Admin Cheat", lang: currentLang });
            for(let i=0; i<amount; i++) {
                const wId = topicId + i + 1;
                db.words.push({ id: wId, topic_id: topicId, english: "cheat", spanish: "cheat", sentence_en: "cheat", sentence_es: "cheat" });
                db.progress.push({ word_id: wId, attempts: 1, successes: 1 });
            }
            app.saveDB();
            alert(`A√±adidas ${amount} palabras a ${app.getLangName()}.`);
            document.body.removeChild(document.getElementById('admin-panel'));
            app.showDashboard();
        },
        
        getCorrectCount: () => {
            return app.getCorrectCountForLang(currentLang);
        },
        
        getCorrectCountForLang: (lang) => {
            return db.progress.filter(p => {
                if (p.successes <= 0) return false;
                const w = db.words.find(w => w.id === p.word_id);
                if (!w) return false;
                const t = db.topics.find(t => t.id === w.topic_id);
                return t && (t.lang || 'en') === lang;
            }).length;
        },
        
        updateLangCounts: () => {
            const selector = document.getElementById('lang-selector');
            if (!selector) return;
            Array.from(selector.options).forEach(opt => {
                if (!opt.getAttribute('data-original')) opt.setAttribute('data-original', opt.text);
                const count = app.getCorrectCountForLang(opt.value);
                opt.text = `${opt.getAttribute('data-original')} (${count})`;
            });
        },
        
        checkDiploma: () => {
            app.switchView('view-diploma');
            const correctCount = app.getCorrectCount();
            
            const container = document.getElementById('diploma-content');
            
            container.innerHTML = `
                <h2 style="color:#007AFF">üéì Diplomas Jetbulary</h2>
                <p>Demuestra tu dominio del idioma. Pronuncia correctamente palabras habituales para conseguir tu certificado.</p>
                <div style="background:white; padding:20px; border-radius:12px; text-align:left; margin:20px 0; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                    <p style="margin:10px 0; color:${correctCount>=100?'#34C759':'#666'}">ü•â <strong>Diploma 100:</strong> 100 palabras (${Math.min(correctCount, 100)}/100) ${correctCount>=100 ? '‚úÖ' : ''}</p>
                    <p style="margin:10px 0; color:${correctCount>=500?'#34C759':'#666'}">ü•à <strong>Diploma 500:</strong> 500 palabras (${Math.min(correctCount, 500)}/500) ${correctCount>=500 ? '‚úÖ' : ''}</p>
                    <p style="margin:10px 0; color:${correctCount>=1000?'#34C759':'#666'}">ü•á <strong>Diploma 1000:</strong> 1000 palabras (${Math.min(correctCount, 1000)}/1000) ${correctCount>=1000 ? '‚úÖ' : ''}</p>
                    <p style="margin:10px 0; color:${correctCount>=5000?'#34C759':'#666'}">üèÜ <strong>Diploma NATIVO:</strong> 5000 palabras (${Math.min(correctCount, 5000)}/5000) ${correctCount>=5000 ? '‚úÖ' : ''}</p>
                </div>
                <p>¬°Sigue practicando para desbloquear el siguiente nivel!</p>
                <button onclick="app.showDashboard()" class="secondary">Volver</button>
            `;
        },

        showDiplomas: () => {
            app.switchView('view-diploma');
            const correctCount = app.getCorrectCount();
            const levels = [100, 500, 1000, 5000];
            const achieved = levels.filter(l => correctCount >= l);
            
            const container = document.getElementById('diploma-content');
            
            if (achieved.length === 0) {
                container.innerHTML = `
                    <h2 style="color:#007AFF">üéì Diplomas Conseguidos</h2>
                    <p>A√∫n no has conseguido ning√∫n diploma. ¬°Sigue practicando!</p>
                    <button onclick="app.showDashboard()" class="secondary">Volver</button>
                `;
            } else {
                let html = `<h2 style="color:#007AFF">üéì Tus Diplomas</h2><p>Selecciona uno para ver y descargar:</p><div style="display:flex; flex-direction:column; gap:10px; margin:20px 0;">`;
                achieved.forEach(l => {
                    let title = `Diploma Jetbulary ${l}`;
                    if (l === 5000) title = "Diploma Jetbulary NATIVO";
                    html += `<button onclick="app.renderDiploma(${l})" class="success">${title}</button>`;
                });
                html += `</div><button onclick="app.showDashboard()" class="secondary">Volver</button>`;
                container.innerHTML = html;
            }
        },

        renderDiploma: (level) => {
            const container = document.getElementById('diploma-content');
            const certTranslations = {
                en: { title: "Certificate of Achievement", awarded: "This certificate is awarded to", reason: "For mastering pronunciation of", words: "Words", in: "in", date: "Date" },
                de: { title: "Urkunde", awarded: "Dieses Zertifikat wird verliehen an", reason: "F√ºr die Beherrschung der Aussprache von", words: "W√∂rter", in: "auf", date: "Datum" },
                fr: { title: "Certificat de R√©ussite", awarded: "Ce certificat est d√©cern√© √†", reason: "Pour la ma√Ætrise de la prononciation de", words: "Mots", in: "en", date: "Date" },
                it: { title: "Certificato di Risultato", awarded: "Questo certificato √® assegnato a", reason: "Per aver padroneggiato la pronuncia di", words: "Parole", in: "in", date: "Data" },
                pt: { title: "Certificado de Conquista", awarded: "Este certificado √© concedido a", reason: "Por dominar a pron√∫ncia de", words: "Palavras", in: "em", date: "Data" },
                ca: { title: "Certificat d'Assoliment", awarded: "Aquest certificat s'atorga a", reason: "Per dominar la pronunciaci√≥ de", words: "Paraules", in: "en", date: "Data" },
                gl: { title: "Certificado de Logro", awarded: "Este certificado out√≥rgase a", reason: "Por dominar a pronuncia de", words: "Palabras", in: "en", date: "Data" },
                eu: { title: "Lorpen Ziurtagiria", awarded: "Ziurtagiri hau honakoari ematen zaio", reason: "Ahoskera menperatzeagatik", words: "Hitz", in: "hizkuntzan", date: "Data" },
                ru: { title: "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –î–æ—Å—Ç–∏–∂–µ–Ω–∏–π", awarded: "–≠—Ç–æ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤—Ä—É—á–∞–µ—Ç—Å—è", reason: "–ó–∞ –æ–≤–ª–∞–¥–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ–º", words: "–°–ª–æ–≤", in: "–Ω–∞", date: "–î–∞—Ç–∞" }
            };
            const t = certTranslations[currentLang] || certTranslations['en'];
            const titleText = level === 5000 ? "Diploma Jetbulary NATIVO" : `Diploma Jetbulary ${level}`;
            
            container.innerHTML = `
                    <h2 style="color:#34C759">üéâ ¬°Felicidades!</h2>
                    <p>Has desbloqueado el <strong>${titleText}</strong>.</p>
                    <p style="font-size:0.9rem; color:#666; background:#fff3cd; padding:10px; border-radius:8px;">‚ö†Ô∏è Jetbulary no almacena tus datos. Este diploma se genera ahora y debes guardarlo t√∫ mismo.</p>
                    
                    <div style="margin:20px 0;">
                        <label style="display:block; text-align:left; margin-bottom:5px; font-weight:bold;">Nombre para el Diploma:</label>
                        <input type="text" id="diploma-name" placeholder="Tu Nombre Completo" oninput="document.getElementById('cert-name').innerText = this.value || 'Tu Nombre'">
                    </div>
                    
                    <div id="diploma-preview" style="border: 10px solid #007AFF; padding: 40px; margin: 20px 0; background: white; color: #333; font-family: 'Georgia', serif; position: relative; overflow: hidden;">
                        <div style="position: absolute; top:0; left:0; width:100%; height:100%; opacity:0.05; background-image: url('logo.jpg'); background-size: cover; pointer-events:none;"></div>
                        <div style="position: relative; z-index: 1;">
                            <h1 style="color: #007AFF; margin: 0 0 10px 0; font-size: 2.5rem;">${titleText}</h1>
                            <div style="width: 100px; height: 2px; background: #007AFF; margin: 10px auto;"></div>
                            <p style="font-size: 1.2rem; margin: 20px 0;">Se otorga el presente reconocimiento a:<br><span style="font-size: 0.9rem; color: #666; font-style: italic;">${t.awarded}:</span></p>
                            <h2 id="cert-name" style="font-size: 2.2rem; margin: 10px 0; color: #000; font-style: italic;">Tu Nombre</h2>
                            <p style="font-size: 1.2rem; margin: 20px 0;">Por haber demostrado su competencia pronunciando correctamente<br><span style="font-size: 0.9rem; color: #666; font-style: italic;">${t.reason}:</span></p>
                            <h3 style="font-size: 3rem; color: #34C759; margin: 10px 0; line-height:1;">${level} Palabras / ${t.words}</h3>
                            <p style="font-size: 1.4rem;">en el idioma / ${t.in} <strong>${app.getLangName()}</strong></p>
                            <div style="margin-top: 40px; display: flex; justify-content: space-between; align-items: end;">
                                <div style="text-align: center;">
                                    <div style="border-bottom: 1px solid #333; width: 150px; margin: 0 auto;"></div>
                                    <p style="font-size: 0.9rem; margin-top: 5px;">Fecha / ${t.date}: ${new Date().toLocaleDateString()}</p>
                                </div>
                                <div style="text-align: center;">
                                    <img src="logo.jpg" style="width: 60px; mix-blend-mode: multiply;">
                                    <p style="font-size: 0.9rem; font-weight: bold; color: #007AFF;">Jetbulary.com</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <p style="font-size:0.9rem; color:#555;">Instrucciones: Pulsa el bot√≥n, y en la ventana de impresi√≥n elige "Guardar como PDF".</p>
                    <button onclick="app.printDiploma()" class="success">üñ®Ô∏è Imprimir / Guardar PDF</button>
                    <button onclick="app.showDiplomas()" class="secondary">Volver</button>
                `;
        },
        
        printDiploma: () => {
            const name = document.getElementById('diploma-name').value;
            if(!name) return alert("Por favor, escribe tu nombre para el diploma.");
            window.print();
        },
        importDB: () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '*/*';
            input.style.display = 'none';
            document.body.appendChild(input);
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if(data.topics && data.words) {
                            if(confirm("Esto sobrescribir√° tus datos actuales. ¬øContinuar?")) {
                                if(data.apiKey) {
                                    localStorage.setItem(API_KEY_STORAGE, data.apiKey);
                                    delete data.apiKey;
                                }
                                db = data;
                                app.saveDB();
                                alert("Datos importados correctamente. La p√°gina se recargar√°.");
                                location.reload();
                            }
                        } else alert("Archivo inv√°lido.");
                    } catch(err) { alert("Error al leer el archivo."); }
                    document.body.removeChild(input);
                };
                reader.readAsText(file);
            };
            input.click();
        },
        
        checkCookies: () => {
            if(!localStorage.getItem('jetbulary_cookies_accepted')) {
                document.getElementById('cookie-banner').classList.remove('hidden');
            }
        },
        acceptCookies: () => {
            localStorage.setItem('jetbulary_cookies_accepted', 'true');
            document.getElementById('cookie-banner').classList.add('hidden');
        },
        
        renderTopics: () => {
            const list = document.getElementById('topic-list');
            const myTopics = db.topics.filter(t => (t.lang || 'en') === currentLang);
            
            if(myTopics.length === 0) list.innerHTML = `<p>No hay temas en ${app.getLangName()}. Crea uno nuevo.</p>`;
            else {
                const reversed = [...myTopics].reverse();
                list.innerHTML = reversed.map((t, index) => `
                    <details ${index === 0 ? 'open' : ''} onclick="app.closeOthers(this)">
                        <summary>${t.name}</summary>
                        <div class="topic-content">
                            <div class="topic-actions">
                                <button onclick="game.start(${t.id}, 'learn')" class="success">Aprender</button>
                                <button onclick="game.start(${t.id}, 'review')" class="warning">Repasar</button>
                            </div>
                            <div class="topic-actions">
                                <button onclick="app.expandTopic(${t.id}, this)" class="secondary">Ampliar</button>
                                <button onclick="app.showTopicCulture(${t.id})" class="secondary">üåç Curiosidades</button>
                                <button onclick="app.deleteTopic(${t.id})" class="danger">Borrar</button>
                            </div>
                        </div>
                    </details>
                `).join('');
            }
        },
        
        closeOthers: (details) => {
            if(!details.open) {
                document.querySelectorAll('details').forEach(d => {
                    if(d !== details) d.removeAttribute('open');
                });
            }
        },
        
        deleteTopic: (id) => {
            if(!confirm("¬øBorrar este tema y todo su vocabulario?")) return;
            db.topics = db.topics.filter(t => t.id !== id);
            db.words = db.words.filter(w => w.topic_id !== id);
            const validWordIds = db.words.map(w => w.id);
            db.progress = db.progress.filter(p => validWordIds.includes(p.word_id));
            app.saveDB();
            app.renderTopics();
        },
        
        renderSuggestions: () => {
            const dailyTopics = [
                "Inteligencia Artificial", "Cambio Clim√°tico", "Exploraci√≥n de Marte", 
                "Teletrabajo", "Salud Mental", "Criptomonedas", "Ciberseguridad", 
                "Minimalismo", "Ciudades del Futuro", "Energ√≠as Renovables", 
                "Redes Sociales", "Globalizaci√≥n", "Avances M√©dicos", "Turismo Espacial", 
                "Econom√≠a Circular", "Derechos Humanos", "Biodiversidad", "Educaci√≥n Online", 
                "Realidad Virtual", "Coches El√©ctricos"
            ];
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = now - start;
            const oneDay = 1000 * 60 * 60 * 24;
            const day = Math.floor(diff / oneDay);
            const dailyTopic = dailyTopics[day % dailyTopics.length];
            
            let prevHtml = '';
            for(let i=1; i<=6; i++) {
                let idx = (day - i) % dailyTopics.length;
                if (idx < 0) idx += dailyTopics.length;
                const t = dailyTopics[idx];
                prevHtml += `<button onclick="app.createTopicFromSuggestion('${t}')" class="secondary" style="width:100%; text-align:left; margin:2px 0; font-size:0.9rem; background:#fff; border:1px solid #eee;">üìÖ Hace ${i} d√≠a${i>1?'s':''}: ${t}</button>`;
            }
            
            const container = document.getElementById('suggestions-container');
            if(container) {
                container.innerHTML = `
                    <button onclick="app.createTopicFromSuggestion('${dailyTopic}')" class="secondary" style="background: #E3F2FD; color: #007AFF; border: 1px solid #BBDEFB; width: 100%; font-weight: bold; margin-bottom: 5px;">üìÖ Tema del D√≠a: ${dailyTopic}</button>
                    <details style="margin-bottom: 15px; border:none; background:transparent; box-shadow:none;">
                        <summary style="font-size: 0.85rem; color: #888; padding: 5px;">Ver temas anteriores (6 d√≠as)...</summary>
                        <div style="display:flex; flex-direction:column; gap:5px; margin-top:5px;">${prevHtml}</div>
                    </details>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="app.createTopicFromSuggestion('Familia y Amigos')" class="secondary" style="flex: 1 1 auto; width: auto;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia</button>
                        <button onclick="app.createTopicFromSuggestion('Comida y Restaurantes')" class="secondary" style="flex: 1 1 auto; width: auto;">üçî Comida</button>
                        <button onclick="app.createTopicFromSuggestion('Viajes y Aeropuerto')" class="secondary" style="flex: 1 1 auto; width: auto;">‚úàÔ∏è Viajes</button>
                        <button onclick="app.createTopicFromSuggestion('Trabajo y Negocios')" class="secondary" style="flex: 1 1 auto; width: auto;">üíº Trabajo</button>
                        <button onclick="app.createTopicFromSuggestion('Rutina Diaria')" class="secondary" style="flex: 1 1 auto; width: auto;">‚è∞ Rutina</button>
                        <button onclick="app.createTopicFromSuggestion('Compras y Ropa')" class="secondary" style="flex: 1 1 auto; width: auto;">üõçÔ∏è Compras</button>
                        <button onclick="app.createTopicFromSuggestion('Salud y Cuerpo')" class="secondary" style="flex: 1 1 auto; width: auto;">üè• Salud</button>
                        <button onclick="app.createTopicFromSuggestion('Tecnolog√≠a')" class="secondary" style="flex: 1 1 auto; width: auto;">üíª Tecnolog√≠a</button>
                        <button onclick="app.createTopicFromSuggestion('Vocabulario Especializado')" class="secondary" style="flex: 1 1 auto; width: auto;">üéì Vocabulario Especializado</button>
                        <button onclick="app.createJobInterviewTopic()" class="secondary" style="flex: 1 1 auto; width: auto;">üëî Tu Profesi√≥n / Entrevistas</button>
                    </div>
                `;
            }
        },
        
        createTopicFromSuggestion: (topic) => {
            document.getElementById('new-topic-input').value = topic;
            app.createTopic();
        },
        
        createJobInterviewTopic: () => {
            const profession = prompt("¬øCu√°l es tu profesi√≥n? (ej: Ingeniero, Enfermera, Camarero...)");
            if (profession) {
                const topicName = `Entrevista de Trabajo para ${profession}`;
                document.getElementById('new-topic-input').value = topicName;
                app.createTopic();
            }
        },
        
        createTopic: async () => {
            const name = document.getElementById('new-topic-input').value;
            if(!name) return;
            const btn = document.getElementById('btn-create');
            
            let topic = db.topics.find(t => t.name.toLowerCase() === name.toLowerCase() && (t.lang || 'en') === currentLang);
            if(topic) return alert("El tema ya existe.");
            
            await app.callAI(name, btn, (vocab) => {
                const newTopic = { id: Date.now(), name: name, lang: currentLang };
                db.topics.push(newTopic);
                vocab.forEach((w, i) => db.words.push({ ...w, id: Date.now()+i, topic_id: newTopic.id }));
                app.saveDB();
                game.start(newTopic.id, 'learn');
            });
        },
        
        expandTopic: async (id, btn) => {
            if(!confirm("¬øA√±adir 10 palabras nuevas?")) return;
            const topic = db.topics.find(t => t.id === id);
            const existing = db.words.filter(w => w.topic_id === id).map(w => w.english).join(', ');
            
            await app.callAI(topic.name, btn, (vocab) => {
                vocab.forEach((w, i) => db.words.push({ ...w, id: Date.now()+i, topic_id: id }));
                app.saveDB();
                alert("Tema ampliado.");
            }, `NO repitas estas palabras: ${existing}.`);
        },
        
        showTopicCulture: async (id) => {
            const topic = db.topics.find(t => t.id === id);
            app.switchView('view-culture');
            document.getElementById('culture-title').innerText = `Curiosidades: ${topic.name}`;
            const container = document.getElementById('culture-content');
            container.innerHTML = '<p>Buscando curiosidades y expresiones...</p>';
            
            const langName = app.getLangName();
            const prompt = `Act√∫a como un experto cultural y ling√º√≠stico. Genera 3 curiosidades o datos culturales interesantes sobre el tema "${topic.name}" en pa√≠ses de habla ${langName}. 
            ADEM√ÅS, incluye 3 expresiones idiom√°ticas o frases hechas relacionadas con este tema que se digan de forma muy diferente en ${langName} respecto al espa√±ol. Para cada expresi√≥n, explica su significado, su traducci√≥n literal (si es curiosa) y c√≥mo se dir√≠a en espa√±ol.
            Usa formato HTML limpio (<h3>, <p>, <ul>, <li>, <strong>). S√© entretenido.`;
            
            await app.callAI_Text(prompt, null, (text) => { container.innerHTML = text; });
        },
        
        showAlphabet: async () => {
            app.switchView('view-alphabet');
            const container = document.getElementById('alphabet-list');
            container.innerHTML = '<p>Cargando signos...</p>';
            
            const langName = app.getLangName();
            const prompt = `Genera una lista de los 20 caracteres/signos/letras m√°s b√°sicos e importantes del idioma ${langName}. 
            Para cada uno dame: el signo, la pronunciaci√≥n aproximada y una palabra de ejemplo.
            Formato JSON array: [{"sign": "A", "pronunciation": "a", "example": "Apple"}]`;
            
            await app.callAI_Text(prompt, null, (text) => {
                try {
                    const json = JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());
                    container.innerHTML = json.map(item => `
                        <div onclick="game.speakText('${item.example}')" style="background:white; padding:10px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer;">
                            <div style="font-size:2rem; font-weight:bold; color:#007AFF;">${item.sign}</div>
                            <div style="font-size:0.8rem; color:#666;">${item.pronunciation}</div>
                            <div style="font-size:0.8rem; color:#333;">Ex: ${item.example}</div>
                        </div>
                    `).join('');
                } catch(e) { container.innerHTML = "Error al cargar alfabeto."; }
            });
        },

        loadResources: async () => {
            const container = document.getElementById('resources-content');
            container.innerHTML = '<p>Generando recursos...</p>';
            const langName = app.getLangName();
            
            const prompt = `Genera una lista √∫til para estudiantes de ${langName} con:
            1. 5 Verbos irregulares comunes.
            2. 5 Conectores de frases √∫tiles.
            3. 5 Phrasal verbs o expresiones idiom√°ticas comunes.
            Usa formato HTML limpio (<h3>, <ul>, <li>, <strong>).`;
            
            await app.callAI_Text(prompt, null, (text) => { container.innerHTML = text; });
        },

        showGrammarCourse: () => {
            document.getElementById('grammar-qa').classList.add('hidden');
            const container = document.getElementById('grammar-course-list');
            container.classList.remove('hidden');
            
            const course = db.grammar_courses && db.grammar_courses[currentLang];
            
            if (!course) {
                container.innerHTML = `
                    <p>No hay un curso creado para ${app.getLangName()}.</p>
                    <button onclick="app.createGrammarCourse(this)" class="success">‚ú® Generar Plan de Estudios con IA</button>
                `;
            } else {
                container.innerHTML = course.map(level => `
                    <div class="level-header">${level.level}</div>
                    ${level.topics.map(topic => `
                        <div class="lesson-item" onclick="app.openGrammarLesson('${level.level}', '${topic}')">
                            üìñ ${topic}
                        </div>
                    `).join('')}
                `).join('');
            }
        },

        createGrammarCourse: async (btn) => {
            const langName = app.getLangName();
            await app.callAI_Text(
                `Genera un temario de gram√°tica para aprender ${langName} dividido en 3 niveles (Principiante, Intermedio, Avanzado). Para cada nivel dame 5 temas clave. 
                Responde SOLO con un JSON v√°lido con este formato: [{"level": "Principiante", "topics": ["Tema 1", "Tema 2"]}, ...]`, 
                btn, 
                (text) => {
                    try {
                        const json = JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());
                        if(!db.grammar_courses) db.grammar_courses = {};
                        db.grammar_courses[currentLang] = json;
                        app.saveDB();
                        app.showGrammarCourse();
                    } catch(e) { alert("Error al procesar la respuesta de la IA: " + e.message); }
                }
            );
        },

        openGrammarLesson: async (level, topic) => {
            const container = document.getElementById('grammar-content');
            document.getElementById('grammar-qa').classList.remove('hidden'); 
            document.getElementById('grammar-course-list').classList.add('hidden');
            document.getElementById('grammar-query').value = topic; 
            
            const btn = document.getElementById('btn-grammar');
            const langName = app.getLangName();
            const prompt = `Act√∫a como una profesora de ${langName}. Explica el tema de gram√°tica: "${topic}" (Nivel ${level}). 
            Incluye: 1. Explicaci√≥n clara. 2. Ejemplos traducidos. 3. Un peque√±o ejercicio al final. Usa formato HTML bonito.`;
            
            await app.callAI_Text(prompt, btn, (text) => {
                container.innerHTML = text;
            });
        },

        askGrammar: async () => {
            const query = document.getElementById('grammar-query').value;
            if(!query) return;
            const btn = document.getElementById('btn-grammar');
            const content = document.getElementById('grammar-content');
            
            const langName = app.getLangName();
            const prompt = `Explica brevemente la gram√°tica de "${query}" en el idioma ${langName}. Usa ejemplos. Formato HTML simple (usa <p>, <ul>, <li>, <strong>).`;
            
            await app.callAI_Text(prompt, btn, (text) => {
                content.innerHTML = text;
            });
        },
        
        getLangName: () => {
            const map = { en: 'Ingl√©s', de: 'Alem√°n', fr: 'Franc√©s', it: 'Italiano', eu: 'Euskera', ru: 'Ruso', pt: 'Portugu√©s', ca: 'Catal√°n', gl: 'Gallego' };
            return map[currentLang] || 'Ingl√©s';
        },

        callAI: async (topicName, btn, callback, extraPrompt = "") => {
            const key = localStorage.getItem(API_KEY_STORAGE);
            if(!key) return alert("Falta la API Key. Config√∫rala en el Login.");
            
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Generando...";
            
            const langName = app.getLangName();
            
            // Restricciones espec√≠ficas por idioma para evitar romanizaci√≥n
            const constraints = {
                ja: "STRICTLY OUTPUT ONLY KANJI/KANA. DO NOT include Romaji, English, or parentheses.",
                ru: "Usa alfabeto Cir√≠lico. NO incluyas transliteraci√≥n.",
                ar: "Usa escritura √Årabe est√°ndar. NO incluyas transliteraci√≥n.",
                he: "Usa escritura Hebrea est√°ndar. NO incluyas transliteraci√≥n."
            };
            const constraint = constraints[currentLang] || "";

            const prompt = `Genera un JSON con 10 palabras en el idioma ${langName} sobre: "${topicName}". ${extraPrompt} 
            IMPORTANTE: El contenido debe estar en ${langName}, aunque las claves del JSON se llamen "english". 
            ${constraint}
            En el campo "english" pon SOLO la palabra en ${langName} (sin pronunciaci√≥n entre par√©ntesis).
            Formato JSON array estricto: [{"english": "palabra_en_${langName}", "spanish": "traducci√≥n_espa√±ol", "sentence_en": "Frase ejemplo en ${langName}", "sentence_es": "Frase traducida al espa√±ol"}] Solo JSON.`;
            
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [{role:"user", content: prompt}],
                        temperature: 0.3
                    })
                });
                if(!res.ok) throw new Error("Error API");
                const data = await res.json();
                const jsonStr = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
                const vocab = JSON.parse(jsonStr);
                callback(vocab);
            } catch(e) {
                alert("Error: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        },
        
        callAI_Text: async (prompt, btn, callback, maxTokens = 2048) => {
            const key = localStorage.getItem(API_KEY_STORAGE);
            if(!key) return alert("Falta API Key");
            
            let originalText = "";
            if (btn) {
                originalText = btn.innerText;
                btn.disabled = true;
                btn.innerText = "...";
            }
            
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [{role:"user", content: prompt}],
                        temperature: 0.5,
                        max_tokens: maxTokens
                    })
                });
                const data = await res.json();
                callback(data.choices[0].message.content);
            } catch(e) { alert(e.message); }
            finally { 
                if (btn) {
                    btn.disabled = false; 
                    btn.innerText = originalText; 
                }
            }
        },
        
        startReview: () => {
            game.start('global_review', 'review');
        }
    };

    const vocab = {
        render: (sortBy = 'score') => {
            const list = document.getElementById('vocab-list');
            const langTopics = db.topics.filter(t => (t.lang || 'en') === currentLang).map(t => t.id);
            let words = db.words.filter(w => langTopics.includes(w.topic_id));
            
            words = words.map(w => {
                const p = db.progress.find(pr => pr.word_id === w.id);
                const score = p && p.attempts > 0 ? Math.round((p.successes/p.attempts)*100) : -1;
                return { ...w, score, topicName: db.topics.find(t => t.id === w.topic_id).name };
            });

            if(sortBy === 'score') words.sort((a,b) => a.score - b.score);
            if(sortBy === 'topic') words.sort((a,b) => a.topicName.localeCompare(b.topicName));
            if(sortBy === 'alpha') words.sort((a,b) => a.english.localeCompare(b.english));

            list.innerHTML = words.map(w => {
                let badge = w.score === -1 ? '<span class="vocab-score" style="background:#999">Nuevo</span>' : 
                            w.score < 50 ? `<span class="vocab-score score-low">${w.score}%</span>` :
                            w.score < 80 ? `<span class="vocab-score score-med">${w.score}%</span>` :
                            `<span class="vocab-score score-high">${w.score}%</span>`;
                
                return `
                <div class="vocab-item" style="flex-direction: column; align-items: flex-start;">
                    <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                        <div class="vocab-info">
                            <div class="vocab-en">${w.english} ${badge}</div>
                            <div class="vocab-es">${w.spanish} <small>(${w.topicName})</small></div>
                        </div>
                        <div class="vocab-controls">
                            <button onclick="game.speakText('${w.english}')" class="secondary" style="padding: 8px 12px;">üîä</button>
                        </div>
                    </div>
                    <div style="font-size: 0.9rem; color: #555; margin-top: 8px; font-style: italic; background: #f9f9f9; padding: 8px; border-radius: 6px; width: 100%; box-sizing: border-box;">
                        "${w.sentence_en}"
                    </div>
                </div>`;
            }).join('');
        },
        sort: (type) => vocab.render(type)
    };

    const game = {
        data: [],
        index: 0,
        recognition: null,
        autoMic: true,
        currentRetries: 0,
        talkInterval: null,
        timerInterval: null,
        wasAutoMic: false,
        
        isCloseMatch: (target, spoken) => {
            if (spoken.includes(target)) return true;
            const a = target, b = spoken;
            if(a.length === 0) return b.length === 0;
            const matrix = [];
            for(let i = 0; i <= b.length; i++) matrix[i] = [i];
            for(let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for(let i = 1; i <= b.length; i++){
                for(let j = 1; j <= a.length; j++){
                    if(b.charAt(i-1) == a.charAt(j-1)) matrix[i][j] = matrix[i-1][j-1];
                    else matrix[i][j] = Math.min(matrix[i-1][j-1] + 1, Math.min(matrix[i][j-1] + 1, matrix[i-1][j] + 1));
                }
            }
            const dist = matrix[b.length][a.length];
            return (1 - dist / Math.max(a.length, b.length)) > 0.45;
        },

        start: (topicId, mode) => {
            let words = [];
            if(topicId === 'global_review') {
                const langTopics = db.topics.filter(t => (t.lang || 'en') === currentLang).map(t => t.id);
                const userProg = db.progress.filter(p => db.words.find(w => w.id === p.word_id && langTopics.includes(w.topic_id)));
                
                userProg.sort((a,b) => (a.successes/a.attempts) - (b.successes/b.attempts));
                words = userProg.slice(0, 10).map(p => db.words.find(w => w.id === p.word_id)).filter(w=>w);
            } else {
                const topic = db.topics.find(t => t.id === topicId);
                if(topic && topic.lang) {
                    currentLang = topic.lang;
                    document.body.className = `lang-${currentLang}`;
                    document.documentElement.lang = currentLang;
                }
                words = db.words.filter(w => w.topic_id === topicId);
                if(mode === 'review') {
                    words = words.filter(w => {
                        const p = db.progress.find(pr => pr.word_id === w.id);
                        return p && p.attempts > 0;
                    });
                }
            }
            
            if(words.length === 0) return alert("No hay palabras disponibles para este modo.");
            
            game.data = words.sort(() => Math.random() - 0.5).slice(0, 10);
            game.index = 0;
            app.switchView('view-game');
            game.updateAvatar();
            game.loadCard();
        },
        
        toggleAutoMic: () => {
            game.autoMic = !game.autoMic;
            const btn = document.getElementById('btn-auto-mic');
            if(game.autoMic) {
                btn.innerHTML = "üéôÔ∏è Auto: ON";
                btn.classList.add('auto-mic-on');
                btn.classList.remove('secondary');
            } else {
                btn.innerHTML = "üéôÔ∏è Auto: OFF";
                btn.classList.remove('auto-mic-on');
                btn.classList.add('secondary');
            }
        },
        
        updateAvatar: () => {
            const containers = document.querySelectorAll('.avatar-container');
            containers.forEach(c => {
                c.innerHTML = '';
                const img = new Image();
                img.className = 'avatar-img';
                img.alt = 'Avatar';
                
                const fallbacks = [
                    'real_en.jpg'
                ];
                
                img.onerror = function() { if(fallbacks.length) this.src = fallbacks.shift(); };
                img.src = `real_${currentLang}.jpg`;
                c.appendChild(img);
            });
        },

        loadCard: () => {
            if(game.index >= game.data.length) {
                alert("Lo has hecho muy bien, sigue practicando, es la mejor forma de aprender un idioma.");
                app.showDashboard();
                return;
            }
            game.stopMic(); // Asegurar que el micro est√° apagado al cargar nueva carta
            const item = game.data[game.index];
            
            // Fix: Escapar caracteres especiales y ajustar regex para idiomas asi√°ticos
            game.currentRetries = 0;
            const escapedWord = item.english.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const isAsian = ['ja', 'th'].includes(currentLang);
            const boundary = isAsian ? '' : '\\b';
            const regex = new RegExp(`${boundary}${escapedWord}${boundary}`, 'gi');
            
            const html = item.sentence_en.replace(regex, `<strong>${item.english}</strong>`);
            document.getElementById('sentence-display').innerHTML = html;
            document.getElementById('word-display').innerText = item.spanish;
            document.getElementById('sentence-translation').innerText = item.sentence_es;
            
            // Link YouGlish din√°mico seg√∫n idioma
            const ygMap = { en: 'english', fr: 'french', de: 'german', it: 'italian', pt: 'portuguese', ru: 'russian' };
            const ygLang = ygMap[currentLang];
            const ygLink = document.getElementById('youglish-link');
            const nativeBtn = document.querySelector('#fail-options button:nth-child(2)');

            if (ygLang) {
                ygLink.href = `https://youglish.com/pronounce/${encodeURIComponent(item.english)}/${ygLang}`;
                ygLink.innerText = "NATIVOS (YouGlish)";
                if(nativeBtn) nativeBtn.innerText = "üëÇ O√≠r Nativos (YouGlish)";
                if(nativeBtn) nativeBtn.style.display = "";
                ygLink.classList.remove('hidden');
            } else if (currentLang === 'eu') {
                ygLink.href = `https://hiztegiak.elhuyar.eus/eu/es/${encodeURIComponent(item.english)}`;
                ygLink.innerText = "Ver en Elhuyar (Diccionario/Contexto) ‚Üó";
                ygLink.href = `https://filmot.com/search/${encodeURIComponent(item.english)}/1?lang=eu`;
                ygLink.innerText = "NATIVOS (Filmot)";
                if(nativeBtn) nativeBtn.innerText = "üëÇ O√≠r Nativos (Filmot)";
                if(nativeBtn) nativeBtn.style.display = "";
                ygLink.classList.remove('hidden');
            } else if (currentLang === 'ca') {
                ygLink.href = `https://www.diccionari.cat/gdlc/${encodeURIComponent(item.english)}`;
                ygLink.innerText = "Ver en Diccionari.cat ‚Üó";
                if(nativeBtn) nativeBtn.style.display = "none";
                ygLink.href = `https://filmot.com/search/${encodeURIComponent(item.english)}/1?lang=ca`;
                ygLink.innerText = "NATIVOS (Filmot)";
                if(nativeBtn) nativeBtn.innerText = "üëÇ O√≠r Nativos (Filmot)";
                if(nativeBtn) nativeBtn.style.display = "";
                ygLink.classList.remove('hidden');
            } else if (currentLang === 'gl') {
                ygLink.href = `https://academia.gal/dicionario/-/termo/${encodeURIComponent(item.english)}`;
                ygLink.innerText = "Ver en Academia Galega ‚Üó";
                if(nativeBtn) nativeBtn.style.display = "none";
                ygLink.href = `https://filmot.com/search/${encodeURIComponent(item.english)}/1?lang=gl`;
                ygLink.innerText = "NATIVOS (Filmot)";
                if(nativeBtn) nativeBtn.innerText = "üëÇ O√≠r Nativos (Filmot)";
                if(nativeBtn) nativeBtn.style.display = "";
                ygLink.classList.remove('hidden');
            } else {
                ygLink.classList.add('hidden');
                if(nativeBtn) nativeBtn.style.display = "none";
            }
            document.getElementById('prompt-pronounce').innerText = `Pulsa y pronuncia en ${app.getLangName()}`;
            
            document.getElementById('feedback-msg').innerText = "";
            document.getElementById('ai-advice').classList.add('hidden');
            document.getElementById('spoken-text').innerText = "...";
            
            const correctCount = app.getCorrectCount();
            let nextThreshold = 100;
            if (correctCount >= 100) nextThreshold = 500;
            if (correctCount >= 500) nextThreshold = 1000;
            if (correctCount >= 1000) nextThreshold = 5000;
            if (correctCount >= 5000) nextThreshold = null;
            
            let scoreText = `Palabras dominadas: ${correctCount}`;
            if (nextThreshold) scoreText += ` | Te quedan ${nextThreshold - correctCount} para Diploma`;
            else scoreText += ` | ¬°Nivel Nativo Alcanzado!`;
            document.getElementById('spoken-text').innerText = scoreText;
            
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('mic-btn').classList.remove('hidden');
            document.getElementById('fail-options').classList.add('hidden');
            
            setTimeout(game.speak, 500);
        },
        
        speak: () => {
            game.speakText(game.data[game.index].sentence_en);
        },
        
        speakWordSlow: () => {
            game.speakText(game.data[game.index].english, 0.5);
        },
        
        speakText: (text, rate = 1) => {
            window.speechSynthesis.cancel();
            if (game.talkInterval) clearInterval(game.talkInterval);
            const u = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();
            
            u.rate = rate;
            let langCode = 'en-US';
            if(currentLang === 'de') langCode = 'de-DE';
            if(currentLang === 'fr') langCode = 'fr-FR';
            if(currentLang === 'it') langCode = 'it-IT';
            if(currentLang === 'eu') langCode = 'es-ES';
            if(currentLang === 'ru') langCode = 'ru-RU';
            if(currentLang === 'pt') langCode = 'pt-PT';
            if(currentLang === 'ca') langCode = 'ca-ES';
            if(currentLang === 'gl') langCode = 'es-ES';
            
            u.lang = langCode;
            
            const femaleNames = ['female', 'woman', 'femenina', 'girl', 'samantha', 'monica', 'amelie', 'anna', 'helena', 'laura', 'marta', 'zira', 'sara', 'carmen', 'paulina', 'huihui', 'yaoyao', 'google'];
            
            // B√∫squeda de voz mejorada
            let f = voices.find(v => (v.lang === langCode || v.lang.replace('_', '-').startsWith(langCode.split('-')[0])) && femaleNames.some(name => v.name.toLowerCase().includes(name)) && !v.name.toLowerCase().includes('male'));
            
            // Fallback: Si no encuentra voz femenina espec√≠fica, usar cualquiera del idioma
            if (!f) f = voices.find(v => v.lang === langCode || v.lang.replace('_', '-').startsWith(langCode.split('-')[0]));
            
            if (f) u.voice = f;
            
            u.onstart = () => {
                document.querySelectorAll('.avatar-container').forEach(el => el.classList.add('talking'));
                
                game.talkInterval = setInterval(() => {
                    const rand = Math.random();
                    const state = rand < 0.1 ? 'closed' : (rand < 0.55 ? 'half' : 'open');
                    
                    document.querySelectorAll('.avatar-img').forEach(img => {
                        img.src = img.src.replace(/_(closed|half|open)\.(png|jpg)/, `_${state}.$2`);
                    });
                }, 100);
            };
            u.onend = () => {
                document.querySelectorAll('.avatar-container').forEach(el => el.classList.remove('talking'));
                if (game.talkInterval) clearInterval(game.talkInterval);
                document.querySelectorAll('.avatar-img').forEach(img => {
                    img.src = img.src.replace(/_(half|open)\.(png|jpg)/, '_closed.$2');
                });
                
                // Auto Mic Trigger
                if (game.autoMic && !document.getElementById('view-game').classList.contains('hidden')) {
                    setTimeout(() => {
                        if (!document.getElementById('mic-btn').classList.contains('listening') && !document.getElementById('view-game').classList.contains('hidden')) {
                            game.toggleMic();
                        }
                    }, 300);
                }
            };
            
            u.onerror = u.onend;
            window.speechSynthesis.speak(u);
        },
        
        toggleMic: () => {
            if(!game.recognition) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if(!SpeechRecognition) return alert("Navegador no soporta voz.");
                game.recognition = new SpeechRecognition();
                
                game.recognition.onresult = (e) => game.check(e.results[0][0].transcript);
                game.recognition.onend = () => {
                    document.getElementById('mic-btn').classList.remove('listening');
                    game.stopTimer();
                };
            }
            let langCode = 'en-US';
            if(currentLang === 'de') langCode = 'de-DE';
            if(currentLang === 'fr') langCode = 'fr-FR';
            if(currentLang === 'it') langCode = 'it-IT';
            if(currentLang === 'eu') langCode = 'eu-ES';
            if(currentLang === 'ru') langCode = 'ru-RU';
            if(currentLang === 'pt') langCode = 'pt-PT';
            if(currentLang === 'ca') langCode = 'ca-ES';
            if(currentLang === 'gl') langCode = 'gl-ES';
            game.recognition.lang = langCode;
            
            try {
                document.getElementById('mic-btn').classList.add('listening');
                game.recognition.start();
                game.startTimer();
            } catch(e) {
                console.error(e);
                document.getElementById('mic-btn').classList.remove('listening');
            }
        },
        
        check: (transcript) => {
            document.getElementById('spoken-text').innerText = `Dijiste: "${transcript}"`;
            let target = game.data[game.index].english.toLowerCase();
            let clean = transcript.toLowerCase().replace(/[.,!?]/g, '').trim();
            
            // Para idiomas asi√°ticos, eliminar espacios para mejorar la comparaci√≥n
            if (['ja', 'th'].includes(currentLang)) {
                target = target.replace(/\s/g, '');
                clean = clean.replace(/\s/g, '');
            }
            
            const correct = game.isCloseMatch(target, clean);
            
            const fb = document.getElementById('feedback-msg');
            
            const wId = game.data[game.index].id;
            let prog = db.progress.find(p => p.word_id === wId);
            if(!prog) {
                prog = { word_id: wId, attempts: 0, successes: 0 };
                db.progress.push(prog);
            }
            prog.attempts++;
            if(correct) prog.successes++;
            app.saveDB();
            game.stopMic();
            
            if(correct) {
                fb.innerText = "¬°Correcto! üéâ";
                fb.className = "feedback correct";
                document.getElementById('mic-btn').classList.add('hidden');
                document.getElementById('ai-advice').classList.add('hidden');
                document.getElementById('fail-options').classList.add('hidden');
                setTimeout(game.next, 1500);

            } else {
                document.getElementById('fail-options').classList.remove('hidden');
                if (game.autoMic) {
                    game.wasAutoMic = true;
                    game.toggleAutoMic();
                }
                fb.innerText = "Incorrecto. Int√©ntalo de nuevo.";
                fb.className = "feedback incorrect";
            }
        },

         stopMic: () => {
            if(game.recognition) {
                try { game.recognition.stop(); } catch(e) {}
                document.getElementById('mic-btn').classList.remove('listening');
                game.stopTimer();
            }
        },
        
        retry: () => {
            if (game.wasAutoMic && !game.autoMic) {
                game.toggleAutoMic();
            }
            game.wasAutoMic = false;
            document.getElementById('fail-options').classList.add('hidden');
            document.getElementById('feedback-msg').innerText = "";
            game.toggleMic();
        },
        
        startTimer: () => {
            const bar = document.getElementById('timer-bar');
            const container = document.getElementById('timer-container');
            container.classList.remove('hidden');
            bar.style.width = '0%';
            bar.style.backgroundColor = '#28a745';
            
            let startTime = Date.now();
            const duration = 5000;
            
            if (game.timerInterval) clearInterval(game.timerInterval);
            
            game.timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const pct = Math.min((elapsed / duration) * 100, 100);
                
                bar.style.width = pct + '%';
                
                if (pct > 50 && pct < 80) bar.style.backgroundColor = '#ffc107';
                else if (pct >= 80) bar.style.backgroundColor = '#dc3545';
                
                if (elapsed >= duration) game.stopMic();
            }, 50);
        },
        
        stopTimer: () => {
            if (game.timerInterval) clearInterval(game.timerInterval);
            document.getElementById('timer-container').classList.add('hidden');
        },
        
        next: () => {
            game.index++;
            game.loadCard();
        },
        
        getMouthAdvice: async (word) => {
            const container = document.getElementById('ai-advice');
            container.innerHTML = "ü§î Buscando consejo de pronunciaci√≥n...";
            container.classList.remove('hidden');
            
            const langName = app.getLangName();
            const prompt = `Dame un consejo breve (m√°x 20 palabras) sobre c√≥mo colocar la boca, lengua o dientes para pronunciar correctamente la palabra "${word}" en ${langName}.`;
            
            await app.callAI_Text(prompt, null, (text) => {
                container.innerHTML = text;
            }, 300);
        }
    };

    window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
    
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        window.deferredPrompt = e;
        const btn = document.getElementById('install-btn');
        if(btn) btn.classList.remove('hidden');
    });
    
    // Ocultar bot√≥n si ya est√° en modo app (instalada)
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
        const btn = document.getElementById('install-btn');
        if(btn) btn.classList.add('hidden');
    }
    
    app.init();
</script>
</body>
</html>
</html>